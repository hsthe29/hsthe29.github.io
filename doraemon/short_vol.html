<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css">
</head>
<body class="dark-background">
    <!-- <div class="navbar">
        <a href="./index.html" id="home">Home</a>
        <a id="list">&#9776;</a>
        <div class="vol-navbar">
            <img src="../icon/left-arrow.png" width="20"/>
            <p style="width: 200px;">Đây là văn bản của bạn</p>
            <img src="../icon/right-arrow.png" width="20"/>
        </div>
    </div> -->
    <nav class="navbar">
        <div class="navbar-left">
            <a href="./index.html" class="nav-icon" id="home">
                <img src="../icon/home-orange.png" width="30"/>
            </a>
            <a id="vol-list" class="nav-icon">
                <img src="../icon/list.png" width="30"/>
            </a>
        </div>
        <div class="navbar-center">
            <img src="../icon/left-arrow.png" id="previous-vol" width="20"/>
            <input readonly id="navbar-text" rows="1" cols="20">
            <img src="../icon/right-arrow.png" id="next-vol" width="20"/>
        </div>
        <div class="navbar-right">
            <img class="profile" src="../icon/profile.png" alt="Profile Picture">
        </div>
    </nav>
    <div class="main" id="main-page">
        <div class="image-container" id="image_container"></div>
        <div class="zoom">
            <img src="../icon/zoom_in.png" width="50" height="auto" id="zoom-in" onclick="zoom_in()"/>
            <img src="../icon/zoom_out.png" width="50" height="auto" id="zoom-out" onclick="zoom_out()"/>
        </div>
    </div>
    <div id="chapter-nav" class="overlay">
        <a class="close-chapter-nav" onclick="closeNav()">&times;</a>
        <div id="chapter-list" class="overlay-content">
        </div>
    </div>
    <div id="open-chapter-nav" class="span-nav">
        <img src="../icon/menu-list.png" height="50" onclick="openNav()"/>
    </div>
    <script>
        const screenWidth = window.innerWidth;
        const orgWidth = 191;
        const orgHeight = 300;
        const maxWidth = 0.9*screenWidth;
        const minWidth = 0.25*screenWidth;
        var curWidth = 0.45*screenWidth;
        var curHeight = orgHeight*curWidth/orgWidth;
        function load_images(subdir, volID, totalPages, chapterPages) {
            let fragmentID = 0;
            const image_container = document.getElementById("image_container");
            for(let i = 0; i < totalPages; i++) {
                const image = document.createElement("img");
                image.setAttribute("alt", `page-${i+1}.jpg`);
                if (i == chapterPages[fragmentID] - 1) {
                    image.setAttribute("id", `chapter-${fragmentID + 1}`);
                    fragmentID++;
                }
                image.src = `./data/${subdir}/short_story/vol_${volID}/page-${i}.webp`;
                image.style.width = `${curWidth}px`;
                image.style.height = `${curHeight}px`;
                image_container.appendChild(image);
            }
        }
        function load_data(subdir, volID) {
            fetch(`./data/${subdir}/short_story/vol_${volID}/chapter.json`)
            .then(response => response.json())
            .then(data => {
                let totalPages = data.pages;
                let chapterObj = data["chapter"]
                let chapterPages = chapterObj.map(obj => parseInt(Object.keys(obj)[0]));
                let chapters = chapterObj.map(obj => Object.values(obj)[0]);
                const link_container = document.getElementById("chapter-list");
                for (let i = 0; i < chapters.length; i++) {
                    const link = document.createElement("a");
                    link.setAttribute("href", `#chapter-${i + 1}`);
                    link.setAttribute("onclick", "closeNav()");
                    link.text = `Chapter ${i+1}: ${chapters[i]}`
                    link_container.appendChild(link);
                }
                const link = document.createElement("a");
                link.text = " "
                link_container.appendChild(link);
                load_images(subdir, volID, totalPages, chapterPages);
            })
            .catch(error => console.error('Error:', error));
        }

        function resize(deltaWidth) {
            let oldPosition = window.pageYOffset || document.documentElement.scrollTop;
            let numPages = parseInt(oldPosition/(curHeight + 10));
            
            let newWidth = curWidth + deltaWidth;
            if (newWidth > maxWidth || newWidth < minWidth)
                return;
            let newHeight = newWidth*curHeight/curWidth;

            var images = document.getElementById("image_container").getElementsByTagName('img');

            for (var i = 0; i < images.length; i++) {
                images[i].style.width = `${newWidth}px`;
                images[i].style.height = `${newHeight}px`;
                if (i < numPages) {
                    let newPosition = oldPosition - curHeight + newHeight;
                    window.scrollTo(0, newPosition);
                    oldPosition = newPosition;
                }
            }
            curWidth = newWidth;
            curHeight = newHeight;
        }

        function zoom_in() {
            resize(10);
        }
        function zoom_out() {
            resize(-10);
        }

        function openNav() {
            document.getElementById('open-chapter-nav').style.display = 'none'; 
            document.getElementById("chapter-nav").style.width = "100%";
        }

        function closeNav() {
            document.getElementById('open-chapter-nav').style.display = 'block'; 
            document.getElementById("chapter-nav").style.width = "0%";
        }


        let queryString = window.location.search;
        let urlParams = new URLSearchParams(queryString);
        let volID = urlParams.get("vol_id");
        let forward = urlParams.get("forward");
        let subdir = (forward == "true")? "forward" : "backward";
        document.title = `Short Doraemon Vol ${volID}`;
        load_data(subdir, volID);
        onclick="location.href='index.html'"
        document.getElementById('vol-list').setAttribute("href", `doraemon.html?type=short&forward=${forward}`);
        document.getElementById('navbar-text').setAttribute("value", ` Doraemon Vol.${volID}`);
        if (volID > 1) {
            document.getElementById('previous-vol').setAttribute(
                "onclick", 
                `location.href="short_vol.html?forward=${forward}&vol_id=${parseInt(volID) - 1}"`);
        }
        if (volID < 45) {
            document.getElementById('next-vol').setAttribute(
                "onclick", 
                `location.href="short_vol.html?forward=${forward}&vol_id=${parseInt(volID) + 1}"`);
        }
        document.getElementById('zoom-in').addEventListener('mousedown', function() {
            zoomInterval = setInterval(zoom_in, 20); // Thực hiện hàm zoomIn mỗi 100ms
        });

        document.getElementById('zoom-out').addEventListener('mousedown', function() {
            zoomInterval = setInterval(zoom_out, 20); // Thực hiện hàm zoomOut mỗi 100ms
        });

        document.getElementById('zoom-in').addEventListener('mouseup', function() {
            clearInterval(zoomInterval); // Dừng lại khi người dùng ngừng nhấn nút
        });

        document.getElementById('zoom-out').addEventListener('mouseup', function() {
            clearInterval(zoomInterval); // Dừng lại khi người dùng ngừng nhấn nút
        });

        document.getElementById('zoom-in').addEventListener('mouseleave', function() {
            clearInterval(zoomInterval); // Dừng lại khi con trỏ chuột rời khỏi nút
        });

        document.getElementById('zoom-out').addEventListener('mouseleave', function() {
            clearInterval(zoomInterval); // Dừng lại khi con trỏ chuột rời khỏi nút
        });

    </script>
</body>
</html>